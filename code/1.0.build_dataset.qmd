---
title: "Building database"
author: "Priscila Stisman"
format: html
editor: visual
---

### Building Dataset

This code uses the `nyt-metadata.csv` file, which contains over 2.1 million New York Times headlines. I extracted samples from the years 2021 to 2025 to analyze how the narrative around energy policy evolved during this periodâ€”particularly before and after the Russia-Ukraine war, which began in February 2022.

The code below outlines the process used to sample headlines from each of these years and combine them into a single dataset, saved as `nyt_combined_2021_2025.csv` in the data folder.



```{r}
###Setup
library(tidyverse)
library(dplyr)
library(quanteda)
library(data.table)
library(here)
library(stringr)
library(ggplot2)
```

```{r}

### Building the database from scratch 

set.seed(2710)

# 20% sample 2021
nyt_2021 <- fread(here("data", "nyt-metadata.csv"),
                 select = c("pub_date", "headline", "abstract", "keywords", "lead_paragraph")) %>%
  # Use ymd_hms to parse dates in YYYY-MM-DD HH:MM:SS format
  mutate(date_parsed = lubridate::ymd_hms(pub_date)) %>%
  # Filter by year
  filter(year(date_parsed) == 2021) %>%
  # Take 5% sample
  sample_frac(0.2)

write_csv(nyt_2021, here("data","nyt_2021.csv"))


# 20% sample 2022
nyt_2022 <- fread(here("data", "nyt-metadata.csv"),
                 select = c("pub_date", "headline", "abstract", "keywords", "lead_paragraph")) %>%
  # Use ymd_hms to parse dates in YYYY-MM-DD HH:MM:SS format
  mutate(date_parsed = lubridate::ymd_hms(pub_date)) %>%
  # Filter by year
  filter(year(date_parsed) == 2022) %>%
  # Take 5% sample
  sample_frac(0.20)

write_csv(nyt_2022, here("data","nyt_2022.csv"))


# 30% sample 2023
nyt_2023 <- fread(here("data", "nyt-metadata.csv"),
                 select = c("pub_date", "headline", "abstract", "keywords", "lead_paragraph")) %>%
  # Use ymd_hms to parse dates in YYYY-MM-DD HH:MM:SS format
  mutate(date_parsed = lubridate::ymd_hms(pub_date)) %>%
  # Filter by year
  filter(year(date_parsed) == 2023) %>%
  # Take 5% sample
  sample_frac(0.3)

write_csv(nyt_2023, here("data","nyt_2023.csv"))


# 80% sample 2024
nyt_2024 <- fread(here("data", "nyt-metadata.csv"),
                 select = c("pub_date", "headline", "abstract", "keywords", "lead_paragraph")) %>%
  # Use ymd_hms to parse dates in YYYY-MM-DD HH:MM:SS format
  mutate(date_parsed = lubridate::ymd_hms(pub_date)) %>%
  # Filter by year
  filter(year(date_parsed) == 2024) %>%
  # Take 5% sample
  sample_frac(0.8)

write_csv(nyt_2024, here("data","nyt_2024.csv"))


# 2025 full
nyt_2025 <- fread(here("data", "nyt-metadata.csv"),
                 select = c("pub_date", "headline", "abstract", "keywords", "lead_paragraph")) %>%
  # Use ymd_hms to parse dates in YYYY-MM-DD HH:MM:SS format
  mutate(date_parsed = lubridate::ymd_hms(pub_date)) %>%
  # Filter by year
  filter(year(date_parsed) == 2025)

write_csv(nyt_2025, here("data","nyt_2025.csv"))




# Combine them all into one dataframe
nyt_combined <- bind_rows(nyt_2021, nyt_2022, nyt_2023, nyt_2024, nyt_2025)

```




```{r}
### Reading the csv and combining them all into a single one

# First read all your individual CSV files
nyt_2021 <- read_csv(here("data", "nyt_2021.csv"))
nyt_2022 <- read_csv(here("data", "nyt_2022.csv"))
nyt_2023 <- read_csv(here("data", "nyt_2023.csv"))
nyt_2024 <- read_csv(here("data", "nyt_2024.csv"))
nyt_2025 <- read_csv(here("data", "nyt_2025.csv"))

# Combine them all into one dataframe
nyt_combined_2021_2025 <- bind_rows(nyt_2021, nyt_2022, nyt_2023, nyt_2024, nyt_2025)

# Write the combined dataset to a new file
write_csv(nyt_combined, here("data", "nyt_combined_2021_2025.csv"))

```